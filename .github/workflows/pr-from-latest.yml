# Quand on push sur "latest", ouvre automatiquement :
#   - une PR vers "main" (tokens web : JSON, CSS, SCSS)
#   - une PR vers "app"  (tokens Android Compose : .kt)
name: PR from latest

on:
  push:
    branches: [latest]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  pr-to-main:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: latest
          fetch-depth: 0

      - name: Create or update PR to main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTING=$(gh pr list --base main --head latest --json number -q '.[0].number')
          if [ -n "$EXISTING" ]; then
            echo "PR #$EXISTING already exists for latest → main"
          else
            gh pr create \
              --base main \
              --head latest \
              --title "chore: sync design tokens → main" \
              --body "Auto-generated PR from **latest** branch.

          Contains web tokens updates (JSON, CSS, SCSS) and Android Compose tokens."
          fi

  pr-to-app:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: app
          fetch-depth: 0

      - name: Copy Android tokens from latest
        id: sync
        run: |
          BRANCH="sync-android-tokens"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin latest
          # Create or reset the sync branch from app
          git checkout -B "$BRANCH" origin/app
          # Copy only dist/android/ from latest
          git checkout origin/latest -- dist/android/
          # Commit if there are changes
          if git diff --staged --quiet; then
            echo "No changes in dist/android/, skipping."
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            git commit -m "chore: sync Android Compose tokens from latest"
            git push -f origin "$BRANCH"
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Create or update PR to app
        if: steps.sync.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          EXISTING=$(gh pr list --base app --head sync-android-tokens --json number -q '.[0].number')
          if [ -n "$EXISTING" ]; then
            echo "PR #$EXISTING already exists for sync-android-tokens → app"
          else
            gh pr create \
              --base app \
              --head sync-android-tokens \
              --title "chore: sync Android Compose tokens → app" \
              --body "Auto-generated PR from **latest** branch.

          Contains only Android Compose token files (\`dist/android/\`)."
          fi
